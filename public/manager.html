<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Military Hotel â€” Manager Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Socket.io -->
  <script src="/socket.io/socket.io.js"></script>

  <style>
    body{
      background:#05060a;
      color:#e5e7eb;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    .glass{
      background:rgba(15,23,42,0.9);
      border-radius:1rem;
      border:1px solid rgba(148,163,184,0.3);
      box-shadow:0 20px 45px rgba(15,23,42,0.9);
    }
    .scrollbar-thin::-webkit-scrollbar{
      width:4px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb{
      background:rgba(148,163,184,0.6);
      border-radius:999px;
    }
    .order-card{
      background:rgba(15,23,42,0.95);
      border-radius:0.85rem;
      border:1px solid rgba(51,65,85,1);
      transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .order-card:hover{
      transform:translateY(-1px);
      box-shadow:0 12px 30px rgba(15,23,42,0.85);
      border-color:rgba(129,140,248,1);
    }
    .status-pill{
      border-radius:999px;
      padding:2px 10px;
      font-size:.7rem;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.06em;
    }
    .btn-soft{
      border-radius:999px;
      padding:6px 12px;
      font-size:.75rem;
      font-weight:600;
      border:1px solid transparent;
      transition:all .12s ease;
    }
    .btn-soft:hover{
      transform:translateY(-0.5px);
      box-shadow:0 8px 18px rgba(30,64,175,0.55);
    }
    .btn-soft-red:hover{
      box-shadow:0 8px 18px rgba(239,68,68,0.55);
    }
    .badge{
      border-radius:999px;
      padding:2px 8px;
      font-size:.7rem;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.06em;
    }
    .section-title{
      font-size:.8rem;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:#9ca3af;
    }
    @media(min-width:1024px){
      .layout{
        display:grid;
        grid-template-columns:2fr 1fr;
        gap:1rem;
      }
    }
  </style>
</head>
<body class="min-h-screen">

  <div class="max-w-7xl mx-auto px-3 py-4 space-y-4">

    <!-- HEADER -->
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <div>
        <h1 class="text-xl md:text-2xl font-semibold text-white tracking-tight">
          Military Hotel â€” Manager
        </h1>
        <p class="text-xs text-slate-400 mt-1">
          Live orders, status control, and daily business insights.
        </p>
      </div>

      <div class="flex flex-wrap items-center gap-2">
        <div class="text-right text-[11px] leading-tight mr-2">
          <div class="font-semibold text-slate-100">Military Hotel</div>
          <div class="text-slate-400">ðŸ“ž +91-XXXXXXXXXX</div>
        </div>
        <span class="badge bg-emerald-500/10 text-emerald-300 border border-emerald-500/40">
          ONLINE
        </span>
        <button id="refreshBtn" class="btn-soft bg-slate-800/70 text-slate-200 border-slate-600/60 flex items-center gap-1">
          <span class="text-xs">âŸ³</span>
          <span>Refresh Orders</span>
        </button>
      </div>
    </header>

    <!-- TOP ROW: DATE + STATS + FILTERS -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">

      <!-- DATE + ORDER COUNTS -->
      <div class="glass p-3.5">
        <div class="flex items-center justify-between mb-3">
          <div>
            <div class="section-title">Orders â€” Selected Date</div>
            <div class="flex items-center gap-2 mt-1">
              <input id="datePicker" type="date"
                     class="bg-slate-900/80 text-xs text-slate-100 rounded-lg border border-slate-600 px-2.5 py-1.5 focus:outline-none focus:ring-1 focus:ring-indigo-500">
            </div>
          </div>
          <div class="text-right">
            <div class="text-xs text-slate-400">Total Orders</div>
            <div id="totalOrders" class="text-lg font-semibold text-indigo-300">0</div>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-2 text-[11px]">
          <div class="bg-slate-900/80 rounded-lg px-2 py-2">
            <div class="text-slate-400">Dine-in</div>
            <div id="countDinein" class="text-sm font-semibold text-slate-100">0</div>
          </div>
          <div class="bg-slate-900/80 rounded-lg px-2 py-2">
            <div class="text-slate-400">Takeaway</div>
            <div id="countTakeaway" class="text-sm font-semibold text-slate-100">0</div>
          </div>
          <div class="bg-slate-900/80 rounded-lg px-2 py-2">
            <div class="text-slate-400">Delivery</div>
            <div id="countDelivery" class="text-sm font-semibold text-slate-100">0</div>
          </div>
        </div>
      </div>

      <!-- TODAY SALES SUMMARY (DAY/WEEK/MONTH) -->
      <div class="glass p-3.5">
        <div class="flex items-center justify-between mb-2">
          <div>
            <div class="section-title">Sales Snapshot</div>
          </div>
          <select id="salesPeriod"
                  class="bg-slate-900/80 text-xs text-slate-100 rounded-lg border border-slate-600 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-indigo-500">
            <option value="day">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-2 text-[11px]">
          <div class="bg-slate-900/80 rounded-lg px-2 py-2">
            <div class="text-slate-400">Total Sales (â‚¹)</div>
            <div id="salesTotal" class="text-sm font-semibold text-indigo-300">0</div>
          </div>
          <div class="bg-slate-900/80 rounded-lg px-2 py-2">
            <div class="text-slate-400">Orders</div>
            <div id="salesCount" class="text-sm font-semibold text-slate-100">0</div>
          </div>
        </div>
      </div>

      <!-- FILTERS / SEARCH REPEAT CUSTOMER -->
      <div class="glass p-3.5">
        <div class="section-title mb-2">Repeat Customers</div>

        <div class="flex gap-2 mb-2">
          <input id="repeatFrom" type="date"
                 class="bg-slate-900/80 text-[11px] text-slate-100 rounded-lg border border-slate-600 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-indigo-500 flex-1">
          <input id="repeatTo" type="date"
                 class="bg-slate-900/80 text-[11px] text-slate-100 rounded-lg border border-slate-600 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-indigo-500 flex-1">
        </div>

        <div class="flex gap-2 mb-2">
          <input id="repeatName"
                 placeholder="Customer name"
                 class="bg-slate-900/80 text-[11px] text-slate-100 rounded-lg border border-slate-600 px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-indigo-500 flex-1">
          <button id="repeatSearchBtn"
                  class="btn-soft bg-indigo-600/90 text-white border-indigo-500/80 text-[11px] px-3 py-1.5">
            Search
          </button>
        </div>

        <div id="repeatResult" class="text-[11px] text-slate-300 min-h-[18px]"></div>
      </div>
    </div>

    <!-- MAIN LAYOUT: ORDERS + RIGHT COLUMN -->
    <div class="layout gap-3">

      <!-- LEFT: ORDERS BOARD -->
      <section class="glass p-3.5">
        <div class="flex items-center justify-between mb-2">
          <div class="section-title">Live Orders Board</div>
          <div class="flex items-center gap-2 text-[11px] text-slate-400">
            <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
            <span>Real-time updates enabled</span>
          </div>
        </div>

        <div class="flex gap-2 text-xs mb-2">
          <span class="badge bg-slate-900/80 text-slate-300 border border-slate-600">Incoming</span>
          <span class="badge bg-slate-900/80 text-slate-300 border border-slate-600">Preparing</span>
          <span class="badge bg-slate-900/80 text-slate-300 border border-slate-600">Delivered</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-[11px]">
          <!-- Incoming -->
          <div>
            <div class="flex items-center justify-between mb-1">
              <span class="text-slate-400 font-semibold text-[11px] uppercase tracking-wide">Incoming</span>
              <span id="countIncoming" class="text-slate-300 text-[11px]">0</span>
            </div>
            <div id="incomingList" class="space-y-1.5 max-h-[65vh] overflow-y-auto pr-1 scrollbar-thin"></div>
          </div>

          <!-- Preparing -->
          <div>
            <div class="flex items-center justify-between mb-1">
              <span class="text-slate-400 font-semibold text-[11px] uppercase tracking-wide">Preparing</span>
              <span id="countPreparing" class="text-slate-300 text-[11px]">0</span>
            </div>
            <div id="preparingList" class="space-y-1.5 max-h-[65vh] overflow-y-auto pr-1 scrollbar-thin"></div>
          </div>

          <!-- Delivered -->
          <div>
            <div class="flex items-center justify-between mb-1">
              <span class="text-slate-400 font-semibold text-[11px] uppercase tracking-wide">Delivered</span>
              <span id="countCompleted" class="text-slate-300 text-[11px]">0</span>
            </div>
            <div id="completedList" class="space-y-1.5 max-h-[65vh] overflow-y-auto pr-1 scrollbar-thin"></div>
          </div>
        </div>
      </section>

      <!-- RIGHT: INSIGHTS & TOP DISH -->
      <aside class="space-y-3">
        <!-- TOP DISH -->
        <div class="glass p-3.5">
          <div class="section-title mb-2">Most Ordered Dish</div>
          <div class="flex gap-2 mb-2">
            <input id="dishFrom" type="date"
                   class="bg-slate-900/80 text-[11px] text-slate-100 rounded-lg border border-slate-600 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-indigo-500 flex-1">
            <input id="dishTo" type="date"
                   class="bg-slate-900/80 text-[11px] text-slate-100 rounded-lg border border-slate-600 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-indigo-500 flex-1">
          </div>
          <button id="dishBtn"
                  class="btn-soft bg-indigo-600/90 text-white border-indigo-500/80 text-[11px] w-full mb-2">
            Run Analysis
          </button>
          <div id="dishResult" class="text-[11px] text-slate-300 min-h-[18px]"></div>
        </div>

        <!-- PEAK HOUR -->
        <div class="glass p-3.5">
          <div class="section-title mb-2">Peak Hour</div>
          <div class="flex items-center justify-between">
            <div class="text-[11px] text-slate-300 max-w-[200px]">
              Identify the busiest hour for the selected date.
            </div>
            <button id="peakBtn"
                    class="btn-soft bg-slate-900/80 text-slate-100 border-slate-600/80 text-[11px]">
              Check
            </button>
          </div>
          <div id="peakResult" class="text-[11px] text-slate-300 mt-2 min-h-[18px]"></div>
        </div>

        <!-- PRINT HELP -->
        <div class="glass p-3.5">
          <div class="section-title mb-2">Bluetooth Print</div>
          <p class="text-[11px] text-slate-300 mb-2">
            Use your browser's Bluetooth print plugin to print order slips.  
            Each order card has a "Print Slip" button.
          </p>
        </div>
      </aside>
    </div>
  </div>

  <script>
    const socket = io();

    socket.on('connected', () => {
      console.log('Manager connected via Socket.io');
    });

    socket.on('newOrder', (order) => {
      console.log('New order via socket:', order);
      loadOrders();
    });

    socket.on('orderUpdated', (order) => {
      console.log('Order updated via socket:', order);
      loadOrders();
    });

    // DOM refs
    const datePicker     = document.getElementById('datePicker');
    const totalOrdersEl  = document.getElementById('totalOrders');
    const cntDinein      = document.getElementById('countDinein');
    const cntTakeaway    = document.getElementById('countTakeaway');
    const cntDelivery    = document.getElementById('countDelivery');

    const incomingList   = document.getElementById('incomingList');
    const preparingList  = document.getElementById('preparingList');
    const completedList  = document.getElementById('completedList');
    const countIncoming  = document.getElementById('countIncoming');
    const countPreparing = document.getElementById('countPreparing');
    const countCompleted = document.getElementById('countCompleted');

    const refreshBtn     = document.getElementById('refreshBtn');

    const salesPeriod    = document.getElementById('salesPeriod');
    const salesTotal     = document.getElementById('salesTotal');
    const salesCount     = document.getElementById('salesCount');

    const repeatFrom     = document.getElementById('repeatFrom');
    const repeatTo       = document.getElementById('repeatTo');
    const repeatName     = document.getElementById('repeatName');
    const repeatSearchBtn= document.getElementById('repeatSearchBtn');
    const repeatResult   = document.getElementById('repeatResult');

    const dishFrom       = document.getElementById('dishFrom');
    const dishTo         = document.getElementById('dishTo');
    const dishBtn        = document.getElementById('dishBtn');
    const dishResult     = document.getElementById('dishResult');

    const peakBtn        = document.getElementById('peakBtn');
    const peakResult     = document.getElementById('peakResult');

    function formatDateInput(date = new Date()){
      return date.toISOString().slice(0,10);
    }

    const todayStr = formatDateInput(new Date());
    datePicker.value = todayStr;
    repeatFrom.value = todayStr;
    repeatTo.value   = todayStr;
    dishFrom.value   = todayStr;
    dishTo.value     = todayStr;

    async function loadOrders(){
      const date = datePicker.value || formatDateInput();
      const res  = await fetch(`/api/orders?date=${date}`);
      const orders = await res.json();

      totalOrdersEl.textContent = orders.length;
      let d=0,t=0,del=0;
      let inc=0,prep=0,comp=0;
      incomingList.innerHTML = '';
      preparingList.innerHTML = '';
      completedList.innerHTML = '';

      orders.forEach(o=>{
        if(o.orderType==='dinein')d++;
        else if(o.orderType==='takeaway')t++;
        else if(o.orderType==='delivery')del++;

        const html = cardHtml(o, o.status==='incoming');
        if(o.status==='incoming'){
          incomingList.insertAdjacentHTML('beforeend', html);
          inc++;
        } else if(o.status==='preparing'){
          preparingList.insertAdjacentHTML('beforeend', html);
          prep++;
        } else if(o.status==='delivered'){
          completedList.insertAdjacentHTML('beforeend', html);
          comp++;
        }
      });

      cntDinein.textContent   = d;
      cntTakeaway.textContent = t;
      cntDelivery.textContent = del;
      countIncoming.textContent  = inc;
      countPreparing.textContent = prep;
      countCompleted.textContent = comp;
    }

    function fmtTime(dStr){
      const d = new Date(dStr);
      return d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
    }

    function renderOrderDetails(o){
      if(o.orderType==='dinein') return `Table: ${o.tableNumber || 'â€”'}`;
      if(o.orderType==='takeaway' || o.orderType==='delivery') return `Address: ${o.address || 'â€”'}`;
      return '';
    }

    function orderTypeBadge(type){
      if(type==='dinein') return '<span class="status-pill bg-emerald-500/10 text-emerald-300 border border-emerald-500/40">Dine-In</span>';
      if(type==='takeaway') return '<span class="status-pill bg-amber-500/10 text-amber-300 border border-amber-500/40">Takeaway</span>';
      if(type==='delivery') return '<span class="status-pill bg-sky-500/10 text-sky-300 border border-sky-500/40">Delivery</span>';
      return '';
    }

    function cardHtml(o, isIncoming){
      const itemsHtml = (o.items||[]).map(i=>`
        <div class="flex justify-between text-[11px]">
          <span>${i.qty}Ã— ${i.name} <span class="text-slate-400">(${i.variant || ''})</span></span>
          <span class="text-slate-100">â‚¹${(i.price||0) * (i.qty||0)}</span>
        </div>
      `).join('');

      const actions = `
        <div class="mt-2 flex flex-wrap gap-1">
          ${o.status==='incoming' ? `
            <button onclick="updateStatus('${o._id}','preparing')" class="btn-soft bg-indigo-600/90 text-white border-indigo-500/80">
              Mark Preparing
            </button>
          `:''}
          ${o.status!=='delivered' ? `
            <button onclick="updateStatus('${o._id}','delivered')" class="btn-soft bg-emerald-600/90 text-white border-emerald-500/80">
              Mark Delivered
            </button>
          `:''}
          <button onclick="printSlip('${o._id}')" class="btn-soft bg-slate-900/80 text-slate-100 border-slate-600/80">
            Print Slip
          </button>
          <button onclick="deleteOrder('${o._id}')" class="btn-soft btn-soft-red bg-red-600/90 text-white border-red-500/80">
            Delete
          </button>
        </div>
      `;

      const regLine = `Reg No: ${o.registrationNumber || 'â€”'} â€¢ ${renderOrderDetails(o)}`;

      return `
        <article class="order-card p-2.5 mb-1.5 text-[11px]">
          <div class="flex justify-between items-start mb-1">
            <div>
              <div class="flex items-center gap-1">
                <span class="font-semibold text-slate-100">${o.customerName || 'Guest'}</span>
                ${orderTypeBadge(o.orderType)}
              </div>
              <div class="text-slate-400 mt-0.5">${regLine}</div>
            </div>
            <div class="text-right">
              <div class="text-slate-400">${fmtTime(o.createdAt)}</div>
              <div class="text-indigo-300 font-semibold text-[12px]">â‚¹${o.total || 0}</div>
            </div>
          </div>
          <div class="border-t border-slate-700/80 my-1.5"></div>
          <div class="space-y-0.5">${itemsHtml || '<div class="text-slate-500">No items</div>'}</div>
          ${actions}
        </article>
      `;
    }

    window.updateStatus = async function(id,status){
      if(!confirm(`Change order status to "${status}"?`))return;
      await fetch(`/api/orders/${id}/status`,{
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({status})
      });
      loadOrders();
    };

    window.deleteOrder = async function(id){
      if(!confirm('Delete this order?'))return;
      await fetch(`/api/orders/${id}/status`,{
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({status:'deleted'})
      });
      loadOrders();
    };

    function buildReceipt(order){
      let out = '';
      out += 'MILITARY HOTEL\n';
      out += line('-');
      out += `Order Type: ${String(order.orderType || '').toUpperCase()}\n`;
      out += `Customer: ${order.customerName || '-'}\n`;
      out += `Reg No: ${order.registrationNumber || '-'}\n`;
      if(order.orderType==='dinein'){
        out += `Table: ${order.tableNumber || '-'}\n`;
      } else {
        out += `Address: ${order.address || '-'}\n`;
      }
      out += line('-');
      out += 'Items\n';
      out += line('-');

      (order.items || []).forEach(i=>{
        const lineName = `${i.qty||0}x ${i.name || ''}`.slice(0,20);
        const lineAmt  = String((i.price||0)*(i.qty||0)).padStart(6,' ');
        out += `${lineName.padEnd(22,' ')}${lineAmt}\n`;
      });

      out += line('-');
      out += `Total: â‚¹${order.total || 0}\n`;
      out += line('-');
      out += 'Thank you!\n';
      return out;
    }

    function line(ch){
      return ch.repeat(30)+'\n';
    }

    async function fetchOrderById(id){
      const date = datePicker.value || formatDateInput();
      const res  = await fetch(`/api/orders?date=${date}`);
      const orders = await res.json();
      return orders.find(o=>o._id===id);
    }

    window.printSlip = async function(id){
      const order = await fetchOrderById(id);
      if(!order){
        alert('Order not found');
        return;
      }
      const receiptText = buildReceipt(order);
      console.log('PRINT RECEIPT:\n'+receiptText);
      alert('Receipt text logged to console. Integrate with Bluetooth printer plugin.');
    };

    async function loadSales(){
      const period = salesPeriod.value || 'day';
      const date   = datePicker.value || formatDateInput();
      const res    = await fetch(`/api/dashboard/sales?period=${period}&date=${date}`);
      const data   = await res.json();
      salesTotal.textContent = data.total || 0;
      salesCount.textContent = data.count || 0;
    }

    async function loadTopDish(){
      const from = dishFrom.value;
      const to   = dishTo.value;
      if(!from || !to){
        dishResult.textContent = 'Please select from & to dates.';
        return;
      }
      const res = await fetch(`/api/dashboard/topdish?from=${from}&to=${to}`);
      const data = await res.json();
      if(!data){
        dishResult.textContent = 'No orders in this period.';
      } else {
        dishResult.textContent = `${data._id} â€” ${data.count} plates ordered.`;
      }
    }

    async function loadPeakHour(){
      const date = datePicker.value || formatDateInput();
      const res  = await fetch(`/api/dashboard/peakhour?date=${date}`);
      const data = await res.json();
      if(!data || data.hour==='-'){
        peakResult.textContent = 'No sufficient orders to determine peak hour.';
      } else {
        peakResult.textContent = `Busiest hour: ${String(data.hour).padStart(2,'0')}:00 with ${data.count} orders.`;
      }
    }

    async function loadRepeatCustomers(){
      const from = repeatFrom.value;
      const to   = repeatTo.value;
      const name = repeatName.value.trim();
      if(!from || !to){
        repeatResult.textContent = 'Select from & to dates.';
        return;
      }
      let url = `/api/dashboard/repeatcustomers?from=${from}&to=${to}`;
      if(name) url += `&name=${encodeURIComponent(name)}`;

      const res  = await fetch(url);
      const list = await res.json();

      if(name){
        const count = (list[0]?.orders) || 0;
        repeatResult.textContent = `${name} placed ${count} orders in this period.`;
      } else {
        if(!list.length){
          repeatResult.textContent = 'No repeat customers in this period.';
        } else {
          const top = list.slice(0,3).map(r=>`${r._id} (${r.orders})`).join(', ');
          repeatResult.textContent = `Top repeat customers: ${top}`;
        }
      }
    }

    refreshBtn.onclick = ()=>{ loadOrders(); };
    datePicker.onchange = ()=>{
      loadOrders();
      loadSales();
    };
    salesPeriod.onchange = loadSales;
    dishBtn.onclick      = loadTopDish;
    peakBtn.onclick      = loadPeakHour;
    repeatSearchBtn.onclick = loadRepeatCustomers;

    loadOrders();
    loadSales();
    loadTopDish();
    loadPeakHour();
    loadRepeatCustomers();
  </script>
</body>
</html>
